variables:
  # TAG: ${CI_PIPELINE_IID}
  # PROJECT_NAME: ${finance-aggregator-miniapp}

stages:
  - sonarqube
  - build
  - push
  - deploy


sonarqube-check:
  stage: sonarqube
  image: 
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script: 
    - sonar-scanner
  allow_failure: true
  tags:
    - shared
    - shell  
  only:
    - dev # or the name of your main branch


build_docker_image:
  stage: build
  script:
    - docker build . -t  $HARBOR_REGISTRY/biletim/api:v$CI_PIPELINE_IID
  tags:
    - shared
    - shell
  only:
    - dev

push_image_repository:
  stage: push
  script:
    - docker login $HARBOR_REGISTRY -u $HARBOR_USER -p $HARBOR_PWD
    - docker push $HARBOR_REGISTRY/biletim/api:v$CI_PIPELINE_IID
  tags:
    - shared
    - shell
  only:
    - dev

deploy:
  stage: deploy
  image:
    name: harbor.westerops.com/k8s/kube:vals2
    entrypoint: [""]
  script:
    # - vals eval -f ./helm/environment/test.values.yaml > ./helm/environment/test_changed.values.yaml
    # - sed -ie "s/IMAGE_TAG/$CI_PIPELINE_IID/g" ./helm/environment/test_changed.values.yaml
    # - helm ls
    # - helm upgrade --install finance-aggregator-miniapp-api -n default -f ./helm/environment/test_changed.values.yaml ./helm
    # - rm -f ./helm/environment/test_changed.values.yaml
    - sed -ie "s/IMAGE_TAG/$CI_PIPELINE_IID/g" ./helm/environment/test.values.yaml
    - helm ls
    - helm upgrade --install biletim-api -n default -f ./helm/environment/test.values.yaml ./helm
  tags:
    - kube20
  only:
    - dev
